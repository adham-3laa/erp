<Page x:Class="erp.Views.Inventory.StockInProductsPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      Background="{StaticResource PageBgBrush}"
      FlowDirection="RightToLeft">

    <!-- ================= Resources ================= -->
    <Page.Resources>

        <DropShadowEffect x:Key="PrimaryOutlineGlow"
                          Color="{Binding Color, Source={StaticResource PrimaryBrush}}"
                          BlurRadius="16"
                          ShadowDepth="0"
                          Opacity="0.30"/>

        <!-- Main Card -->
        <Style x:Key="StockCardStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="18"/>
            <Setter Property="Background" Value="{StaticResource CardBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="{StaticResource SoftBorderBrush}"/>
            <Setter Property="Padding" Value="24"/>
            <Setter Property="Effect" Value="{StaticResource PrimaryOutlineGlow}"/>
        </Style>

        <!-- Field title -->
        <Style x:Key="FieldTitleStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Foreground" Value="{StaticResource TextMutedBrush}"/>
            <Setter Property="Margin" Value="0,14,0,6"/>
        </Style>

        <!-- TextBox (safe) -->
        <Style x:Key="StockTextBoxStyle" TargetType="TextBox">
            <Setter Property="Height" Value="38"/>
            <Setter Property="Padding" Value="10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Background" Value="Transparent"/>
        </Style>

        <!-- DataGrid -->
        <Style x:Key="StockDataGridStyle" TargetType="DataGrid">
            <Setter Property="RowHeight" Value="44"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="CanUserAddRows" Value="True"/>
            <Setter Property="HeadersVisibility" Value="Column"/>
        </Style>

    </Page.Resources>

    <!-- ================= Layout ================= -->
    <Grid Margin="28">
        <Border Style="{StaticResource StockCardStyle}"
                Width="720"
                HorizontalAlignment="Center"
                VerticalAlignment="Center">

            <StackPanel>

                <!-- ================= Header ================= -->
                <Grid Margin="0,0,0,20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Button Content="⬅ رجوع"
                            Width="110"
                            Height="40"
                            Style="{StaticResource DarkButtonStyle}"
                            Click="Back_Click"/>

                    <TextBlock Grid.Column="1"
                               Text="تحديث كمية المنتجات"
                               FontSize="26"
                               FontWeight="Bold"
                               Foreground="{StaticResource TextDarkBrush}"
                               HorizontalAlignment="Center"
                               VerticalAlignment="Center"/>
                </Grid>

                <!-- ================= Supplier ================= -->
                <TextBlock Text="اسم المورد"
                           Style="{StaticResource FieldTitleStyle}"/>

                <Grid>
                    <Border CornerRadius="10"
                            BorderThickness="1"
                            BorderBrush="{StaticResource SoftBorderBrush}">
                        <TextBox x:Name="SupplierNameTextBox"
                                 Style="{StaticResource StockTextBoxStyle}"
                                 TextChanged="SupplierNameTextBox_TextChanged"
                                 GotFocus="SupplierNameTextBox_GotFocus"
                                 LostFocus="SupplierNameTextBox_LostFocus"
                                 KeyDown="SupplierNameTextBox_KeyDown"/>
                    </Border>

                    <!-- Suggestions Popup for Supplier -->
                    <Border x:Name="SupplierSuggestionsBorder"
                            Background="White"
                            CornerRadius="8"
                            BorderBrush="#DDD"
                            BorderThickness="1"
                            Margin="0,42,0,0"
                            Visibility="Collapsed"
                            MaxHeight="200">
                        <Border.Effect>
                            <DropShadowEffect Color="#40000000"
                                              BlurRadius="8"
                                              ShadowDepth="2"
                                              Opacity="0.3"/>
                        </Border.Effect>
                        <ListBox x:Name="SupplierSuggestionsListBox"
                                 BorderThickness="0"
                                 SelectionChanged="SupplierSuggestionsListBox_SelectionChanged"
                                 MouseLeftButtonUp="SupplierSuggestionsListBox_MouseLeftButtonUp"
                                 PreviewMouseDown="SupplierSuggestionsListBox_PreviewMouseDown">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Padding="10"
                                               Cursor="Hand"
                                               Text="{Binding}"/>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Border>
                </Grid>

                <!-- ================= Products ================= -->
                <TextBlock Text="المنتجات"
                           FontSize="18"
                           FontWeight="Bold"
                           Margin="0,28,0,10"/>

                <Grid>
                    <Border CornerRadius="12"
                            BorderThickness="1"
                            BorderBrush="{StaticResource SoftBorderBrush}">

                        <DataGrid x:Name="ProductsGrid"
                              Style="{StaticResource StockDataGridStyle}"
                              AutoGenerateColumns="False"
                              Height="260"
                              CanUserAddRows="False">

                            <DataGrid.Columns>
                            <DataGridTemplateColumn Header="اسم المنتج" Width="*">
                                <DataGridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <Border CornerRadius="6"
                                                BorderThickness="1"
                                                BorderBrush="#E5E7EB"
                                                Margin="2">
                                            <TextBox Text="{Binding productname, UpdateSourceTrigger=PropertyChanged}"
                                                     BorderThickness="0"
                                                     Background="Transparent"
                                                     Padding="8"
                                                     FontSize="14"
                                                     TextChanged="ProductNameCell_TextChanged"
                                                     GotFocus="ProductNameCell_GotFocus"
                                                     LostFocus="ProductNameCell_LostFocus"
                                                     KeyDown="ProductNameCell_KeyDown"/>
                                        </Border>
                                    </DataTemplate>
                                </DataGridTemplateColumn.CellTemplate>
                            </DataGridTemplateColumn>

                            <DataGridTextColumn Header="الكمية"
                                                Binding="{Binding quantity}"
                                                Width="140"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </Border>

                    <!-- Global Popup for Product Suggestions in DataGrid -->
                    <Popup x:Name="ProductSuggestionsPopup"
                           Placement="Bottom"
                           StaysOpen="True"
                           AllowsTransparency="True"
                           PopupAnimation="Fade">   

                        <Border Background="White"
                                CornerRadius="8"
                                BorderBrush="#DDD"
                                BorderThickness="1"
                                MaxHeight="200"
                                MinWidth="200">
                            <Border.Effect>
                                <DropShadowEffect Color="#40000000"
                                                  BlurRadius="8"
                                                  ShadowDepth="2"
                                                  Opacity="0.3"/>
                            </Border.Effect>
                            <ListBox x:Name="ProductSuggestionsPopupListBox"
                                     BorderThickness="0"
                                     MouseLeftButtonUp="ProductSuggestionsPopupListBox_MouseLeftButtonUp"
                                     PreviewMouseDown="ProductSuggestionsPopupListBox_PreviewMouseDown">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Padding="10"
                                                   Cursor="Hand"
                                                   Text="{Binding}"/>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </Border>
                    </Popup>
                </Grid>

                <!-- ================= Action ================= -->
                <StackPanel Orientation="Horizontal"
                            HorizontalAlignment="Left"
                            Margin="0,28,0,0">

                    <Button Content="تنفيذ التحديث"
                            Width="180"
                            Height="44"
                            Style="{StaticResource DarkButtonStyle}"
                            Click="Execute_Click"/>
                </StackPanel>

            </StackPanel>
        </Border>
    </Grid>
</Page>
