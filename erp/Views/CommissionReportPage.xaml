<Page x:Class="erp.Views.Reports.CommissionReportPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      FlowDirection="RightToLeft"
      Background="#F5F6FA">

    <!-- ✅ Resources -->
    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>

        <!-- Base Button -->
        <Style x:Key="SimpleButton" TargetType="Button">
            <Setter Property="Background" Value="#6B7280"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="14,8"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="12">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="ActiveTabButton" TargetType="Button" BasedOn="{StaticResource SimpleButton}">
            <Setter Property="Background" Value="#1E1B4B"/>
        </Style>

        <!-- ✅ Search small -->
        <Style x:Key="SearchTextBox" TargetType="TextBox">
            <Setter Property="Height" Value="34"/>
            <Setter Property="Padding" Value="10,6"/>
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="Background" Value="#FFFFFF"/>
        </Style>

        <Style x:Key="PrimaryButton" TargetType="Button" BasedOn="{StaticResource SimpleButton}">
            <Setter Property="Background" Value="#1E1B4B"/>
            <Setter Property="Padding" Value="18,8"/>
            <Setter Property="FontSize" Value="13"/>
        </Style>

        <Style x:Key="CardValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="20"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Margin" Value="0,6,0,0"/>
        </Style>
    </Page.Resources>

    <Grid Margin="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 🔝 Top Nav -->
        <StackPanel Orientation="Horizontal" Margin="0,0,0,16">
            <Button Content="📊 تقرير المبيعات"
                    Style="{StaticResource SimpleButton}"
                    Click="OpenSalesReport"
                    Margin="0,0,8,0"/>

            <Button Content="📦 حركة صنف"
                    Style="{StaticResource SimpleButton}"
                    Click="OpenStockMovementReport"
                    Margin="0,0,8,0"/>

            <Button Content="💰 عمولات المندوبين"
                    Style="{StaticResource ActiveTabButton}"/>
        </StackPanel>

        <!-- 🧾 العنوان -->
        <StackPanel Grid.Row="1" Margin="0,0,0,12">
            <TextBlock Text="تقرير عمولات المندوبين"
                       FontSize="24"
                       FontWeight="Bold"
                       Foreground="#111827"/>
            <TextBlock Text="عرض العمولات وعدد الطلبات لكل مندوب"
                       FontSize="13"
                       Foreground="#6B7280"
                       Margin="0,4,0,0"/>
        </StackPanel>

        <!-- 🔍 البحث (أصغر) -->
        <Border Grid.Row="2"
                Background="White"
                CornerRadius="18"
                BorderBrush="#E5E7EB"
                BorderThickness="1"
                Padding="12"
                Margin="0,0,0,14">

            <Grid VerticalAlignment="Center">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox Grid.Column="0"
                         Width="420"
                         Style="{StaticResource SearchTextBox}"
                         Text="{Binding SalesRepId, UpdateSourceTrigger=PropertyChanged}"
                         materialDesign:HintAssist.Hint="رقم المندوب (SalesRep ID)"
                         materialDesign:HintAssist.Foreground="#6B7280"/>

                <Button Grid.Column="1"
                        Width="130"
                        Content="تحميل"
                        Command="{Binding LoadReportCommand}"
                        Style="{StaticResource PrimaryButton}"
                        Margin="10,0,0,0"
                        Height="34"/>
            </Grid>
        </Border>

        <!-- 📊 المحتوى -->
        <Grid Grid.Row="3">

            <!-- ✅ الجدول موجود لكن مخفي نهائيًا (مش هنحذفه) -->
            <materialDesign:Card Padding="8"
                                 materialDesign:ElevationAssist.Elevation="Dp1"
                                 Visibility="Collapsed">

                <DataGrid ItemsSource="{Binding Items}"
                          AutoGenerateColumns="False"
                          CanUserAddRows="False"
                          RowHeight="40">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="اسم المندوب"
                                            Binding="{Binding SalesRepName}"
                                            Width="*"/>

                        <DataGridTextColumn Header="إجمالي العمولات"
                                            Binding="{Binding TotalCommission}"
                                            Width="200"/>

                        <DataGridTextColumn Header="عدد الطلبات"
                                            Binding="{Binding TotalOrdersConfirmed}"
                                            Width="200"/>
                    </DataGrid.Columns>
                </DataGrid>
            </materialDesign:Card>

            <!-- ✅ Cards View (تظهر فقط بعد البحث ولو فيه بيانات) -->
            <ScrollViewer VerticalScrollBarVisibility="Auto">
                <ScrollViewer.Style>
                    <Style TargetType="ScrollViewer">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding HasSearched}" Value="True"/>
                                    <Condition Binding="{Binding NoData}" Value="False"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Visibility" Value="Visible"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </ScrollViewer.Style>

                <ItemsControl ItemsSource="{Binding Items}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel IsItemsHost="True"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>

                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Width="340"
                                    Margin="8"
                                    Padding="18"
                                    CornerRadius="18"
                                    Background="White"
                                    BorderBrush="#E5E7EB"
                                    BorderThickness="1">
                                <StackPanel>

                                    <!-- اسم المندوب -->
                                    <TextBlock Text="{Binding SalesRepName}"
                                               FontSize="16"
                                               FontWeight="Bold"
                                               Foreground="#111827"
                                               Margin="0,0,0,12"/>

                                    <!-- كروت داخلية -->
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition/>
                                            <ColumnDefinition/>
                                        </Grid.ColumnDefinitions>

                                        <!-- إجمالي العمولات -->
                                        <Border Grid.Column="0"
                                                Margin="0,0,8,0"
                                                Padding="14"
                                                CornerRadius="16"
                                                Background="#FF4E88D2">
                                            <StackPanel>
                                                <TextBlock Text="إجمالي العمولات"
                                                           Foreground="#DBEAFE"
                                                           FontSize="12"/>
                                                <TextBlock Text="{Binding TotalCommission, StringFormat='{}{0:N0}'}"
                                                           Style="{StaticResource CardValue}"/>
                                            </StackPanel>
                                        </Border>

                                        <!-- عدد الطلبات -->
                                        <Border Grid.Column="1"
                                                Padding="14"
                                                CornerRadius="16"
                                                Background="#FF549476">
                                            <StackPanel>
                                                <TextBlock Text="عدد الطلبات"
                                                           Foreground="#D1FAE5"
                                                           FontSize="12"/>
                                                <TextBlock Text="{Binding TotalOrdersConfirmed}"
                                                           Style="{StaticResource CardValue}"/>
                                            </StackPanel>
                                        </Border>
                                    </Grid>

                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- ⏳ Loading Overlay -->
            <Border Background="#80FFFFFF"
                    Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel HorizontalAlignment="Center"
                            VerticalAlignment="Center">
                    <ProgressBar Width="220"
                                 Height="6"
                                 IsIndeterminate="True"/>
                    <TextBlock Text="جاري تحميل التقرير..."
                               Foreground="#111827"
                               Margin="0,10,0,0"/>
                </StackPanel>
            </Border>

            <!-- ✅ لا توجد بيانات (تظهر فقط بعد البحث) -->
            <TextBlock Text="لا توجد بيانات"
                       FontSize="16"
                       Foreground="Gray"
                       HorizontalAlignment="Center"
                       VerticalAlignment="Center">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <MultiDataTrigger>
                                <MultiDataTrigger.Conditions>
                                    <Condition Binding="{Binding HasSearched}" Value="True"/>
                                    <Condition Binding="{Binding NoData}" Value="True"/>
                                </MultiDataTrigger.Conditions>
                                <Setter Property="Visibility" Value="Visible"/>
                            </MultiDataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

        </Grid>
    </Grid>
</Page>
