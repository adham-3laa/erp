<Page x:Class="erp.Views.CreateReturnView"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
      xmlns:converters="clr-namespace:erp.Converters"
      mc:Ignorable="d"
      FlowDirection="RightToLeft"
      Background="#F5F6FA"
      Title="إنشاء طلب إرجاع">

    <Page.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <Style x:Key="ModernTextBox" TargetType="TextBox" BasedOn="{StaticResource MaterialDesignOutlinedTextBox}">
            <Setter Property="Height" Value="45"/>
            <Setter Property="Padding" Value="12,10"/>
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="Foreground" Value="#1F2937"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderBrush" Value="#E5E7EB"/>
            <Setter Property="materialDesign:TextFieldAssist.TextFieldCornerRadius" Value="6"/>
            <Setter Property="materialDesign:TextFieldAssist.HasClearButton" Value="True"/>
            <Setter Property="materialDesign:HintAssist.IsFloating" Value="False"/>
        </Style>

        <Style x:Key="ActionButton" TargetType="Button">
            <Setter Property="Background" Value="#4F46E5"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="24,10"/>
            <Setter Property="Margin" Value="0,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="6">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#4338CA"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Opacity" Value="0.5"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Segmented Control Button Style -->
        <Style x:Key="SegmentRadioButton" TargetType="RadioButton">
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="RadioButton">
                        <Border x:Name="Border" 
                                Background="Transparent" 
                                BorderBrush="#E5E7EB" 
                                BorderThickness="1" 
                                CornerRadius="0"
                                Padding="20,10">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsChecked" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#4F46E5"/>
                                <Setter Property="Foreground" Value="White"/>
                                <Setter TargetName="Border" Property="BorderBrush" Value="#4F46E5"/>
                            </Trigger>
                            <Trigger Property="IsChecked" Value="False">
                                <Setter TargetName="Border" Property="Background" Value="White"/>
                                <Setter Property="Foreground" Value="#374151"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
        <converters:StringNotEmptyToVisibilityConverter x:Key="StringNotEmptyVis"/>
    </Page.Resources>

    <Grid Margin="30">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="Auto"/> <!-- Status Messages -->
            <RowDefinition Height="Auto"/> <!-- Toggle -->
            <RowDefinition Height="*"/>    <!-- Content -->
            <RowDefinition Height="Auto"/> <!-- Footer -->
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,10">
            <Button Content="⬅ رجوع" Click="Back_Click" HorizontalAlignment="Left" Background="Transparent" Foreground="#6B7280" BorderThickness="0"/>
            <TextBlock Text="إدارة المرتجعات" FontSize="28" FontWeight="Bold" Foreground="#111827" Margin="0,5,0,0"/>
            <TextBlock Text="قم باختيار نوع العملية وإدخال البيانات المطلوبة" FontSize="14" Foreground="#6B7280" Margin="0,5,0,0"/>
        </StackPanel>
        
        <!-- Status Message Block -->
        <Border Grid.Row="1" Margin="0,0,0,20" CornerRadius="6" Padding="15"
                Visibility="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyVis}, FallbackValue=Collapsed}">
            <Border.Style>
                 <Style TargetType="Border">
                     <Setter Property="Background" Value="#FEE2E2"/>
                     <Setter Property="BorderBrush" Value="#EF4444"/>
                     <Setter Property="BorderThickness" Value="1"/>
                 </Style>
            </Border.Style>
            <TextBlock Text="{Binding ErrorMessage}" Foreground="#DC2626" FontWeight="SemiBold" TextWrapping="Wrap"/>
        </Border>

        <!-- Toggle (Customer vs Supplier) -->
        <Border Grid.Row="2" HorizontalAlignment="Left" CornerRadius="6" BorderBrush="#E5E7EB" BorderThickness="1" Background="White" Margin="0,0,0,20">
            <StackPanel Orientation="Horizontal">
                <RadioButton Content="إرجاع من عميل" IsChecked="{Binding IsCustomerReturn}" Style="{StaticResource SegmentRadioButton}" GroupName="ReturnType"/>
                <RadioButton Content="إرجاع لمورد" IsChecked="{Binding IsSupplierReturn}" Style="{StaticResource SegmentRadioButton}" GroupName="ReturnType"/>
            </StackPanel>
        </Border>

        <!-- Main Content Area -->
        <Grid Grid.Row="3">
            
            <!-- CUSTOMER RETURN PANEL -->
            <Grid Visibility="{Binding IsCustomerReturn, Converter={StaticResource BoolToVis}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Input Order ID -->
                <Border Background="White" CornerRadius="8" Padding="20" Margin="0,0,0,20">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition Width="300"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="رقم الطلب (Order Code):" VerticalAlignment="Center" FontSize="14" FontWeight="SemiBold" Margin="0,0,10,0"/>
                        <TextBox Grid.Column="1" Text="{Binding OrderCode, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBox}" materialDesign:HintAssist.Hint="أدخل رقم الطلب هنا..."/>
                        <Button Grid.Column="2" Content="جلب المنتجات" Command="{Binding FetchOrderCommand}" Style="{StaticResource ActionButton}" Margin="10,0,0,0"/>
                    </Grid>
                </Border>

                <!-- Order Items Grid -->
                <DataGrid Grid.Row="1" ItemsSource="{Binding OrderItems}" AutoGenerateColumns="False" CanUserAddRows="False" Background="White" BorderThickness="0" HeadersVisibility="Column">
                    <DataGrid.Resources>
                        <Style TargetType="DataGridColumnHeader">
                            <Setter Property="Padding" Value="10"/>
                            <Setter Property="Background" Value="#F9FAFB"/>
                            <Setter Property="FontWeight" Value="SemiBold"/>
                        </Style>
                        <Style TargetType="DataGridCell">
                            <Setter Property="Padding" Value="10"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="DataGridCell">
                                        <Border Padding="{TemplateBinding Padding}" Background="{TemplateBinding Background}">
                                            <ContentPresenter VerticalAlignment="Center"/>
                                        </Border>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </DataGrid.Resources>
                    <DataGrid.Columns>
                        <DataGridCheckBoxColumn Binding="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}" Header="تحديد"/>
                        <DataGridTextColumn Binding="{Binding Dto.productname}" Header="اسم المنتج" IsReadOnly="True" Width="*"/>
                        <DataGridTextColumn Binding="{Binding Dto.quantity}" Header="تم شراؤه" IsReadOnly="True" Width="Auto"/>
                        <DataGridTemplateColumn Header="الكمية المرتجعة" Width="120">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBox Text="{Binding ReturnQuantity, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBox}" Height="30" TextAlignment="Center"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                        <DataGridTemplateColumn Header="سبب الإرجاع" Width="2*">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <TextBox Text="{Binding Reason, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBox}" Height="30" materialDesign:HintAssist.Hint="اكتب السبب..."/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- SUPPLIER RETURN PANEL -->
            <Grid Visibility="{Binding IsSupplierReturn, Converter={StaticResource BoolToVis}}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Supplier Selection -->
                <Border Grid.Row="0" Background="White" CornerRadius="8" Padding="20" Margin="0,0,0,15">
                     <StackPanel>
                        <TextBlock Text="اسم المورد" FontSize="14" FontWeight="SemiBold" Margin="0,0,0,5"/>
                         <Grid>
                             <TextBox x:Name="SupplierNameBox" 
                                      Text="{Binding SupplierName, UpdateSourceTrigger=PropertyChanged}" 
                                      Style="{StaticResource ModernTextBox}"
                                      PreviewKeyDown="SupplierNameBox_PreviewKeyDown"/>
                             
                             <Popup IsOpen="{Binding IsSupplierSuggestionOpen, Mode=TwoWay}" 
                                    PlacementTarget="{Binding ElementName=SupplierNameBox}"
                                    StaysOpen="False"
                                    AllowsTransparency="True"
                                    Width="{Binding ActualWidth, ElementName=SupplierNameBox}">
                                 <Border Background="White" BorderBrush="#E5E7EB" BorderThickness="1" CornerRadius="4">
                                     <ListBox x:Name="SupplierList"
                                              ItemsSource="{Binding FilteredSupplierSuggestions}"
                                              SelectedItem="{Binding SelectedSupplierSuggestion, UpdateSourceTrigger=PropertyChanged}"
                                              MaxHeight="150"
                                              BorderThickness="0"/>
                                 </Border>
                             </Popup>
                         </Grid>
                     </StackPanel>
                </Border>

                <!-- Add Item Form -->
                <Border Grid.Row="1" Background="White" CornerRadius="8" Padding="20" Margin="0,0,0,15">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="1*"/>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="اسم المنتج" FontSize="12" Foreground="Gray"/>
                        <TextBlock Grid.Column="1" Text="الكمية" FontSize="12" Foreground="Gray" Margin="10,0,0,0"/>
                        <TextBlock Grid.Column="2" Text="السبب" FontSize="12" Foreground="Gray" Margin="10,0,0,0"/>

                        <StackPanel Grid.Row="1" Margin="10,10,10,0">
                            <!-- Product Autocomplete Logic could be added here similar to Supplier, but trying simpel ComboBox for now as per VM -->
                            <ComboBox IsEditable="True"
                                      ItemsSource="{Binding ProductSuggestions}"
                                      Text="{Binding ProductSearchText, UpdateSourceTrigger=PropertyChanged}"
                                      StaysOpenOnEdit="True"
                                      Height="45"
                                      Style="{StaticResource MaterialDesignOutlinedComboBox}"/>
                        </StackPanel>

                        <TextBox Grid.Row="1" Grid.Column="1" Margin="10,10,0,0" Text="{Binding CurrentSupplierItem.Quantity, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBox}" Height="45"/>
                        <TextBox Grid.Row="1" Grid.Column="2" Margin="10,10,0,0" Text="{Binding CurrentSupplierItem.Reason, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource ModernTextBox}" Height="45"/>
                        
                        <Button Grid.Row="1" Grid.Column="3" Content="إضافة" Command="{Binding AddSupplierItemCommand}" Style="{StaticResource ActionButton}" Margin="10,10,0,0" Background="#10B981" BorderBrush="#10B981" Height="45"/>
                    </Grid>
                </Border>

                <!-- Items to Return List -->
                <DataGrid Grid.Row="2" ItemsSource="{Binding ItemsToReturn}" AutoGenerateColumns="False" CanUserAddRows="False" Background="White" BorderThickness="0" HeadersVisibility="Column">
                    <DataGrid.Columns>
                        <DataGridTextColumn Binding="{Binding ProductName}" Header="المنتج" Width="*"/>
                        <DataGridTextColumn Binding="{Binding Quantity}" Header="الكمية" Width="Auto"/>
                        <DataGridTextColumn Binding="{Binding Reason}" Header="السبب" Width="2*"/>
                        <DataGridTemplateColumn Width="Auto">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <Button Content="🗑" 
                                            Command="{Binding DataContext.RemoveItemCommand, RelativeSource={RelativeSource AncestorType=Page}}" 
                                            CommandParameter="{Binding}"
                                            Background="#EF4444" 
                                            Foreground="White" 
                                            Padding="10,5"
                                            BorderThickness="0"/>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

        </Grid>

        <!-- Footer / Submit -->
        <Border Grid.Row="4" Margin="0,20,0,0" BorderBrush="#E5E7EB" BorderThickness="0,1,0,0" Padding="0,20,0,0">
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                <TextBlock Text="{Binding ErrorMessage}" Foreground="#EF4444" VerticalAlignment="Center" Margin="0,0,20,0" FontWeight="SemiBold"/>
                <Button Command="{Binding SubmitReturnCommand}" Height="45" Width="200" Style="{StaticResource ActionButton}">
                    <Button.Content>
                         <Binding Path="IsCustomerReturn">
                             <Binding.Converter>
                                 <converters:BoolToTextConverter TrueText="تأكيد إرجاع العميل" FalseText="تأكيد إرجاع المورد"/>
                             </Binding.Converter>
                         </Binding>
                    </Button.Content>
                </Button>
            </StackPanel>
        </Border>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="5" Visibility="{Binding IsBusy, Converter={StaticResource BoolToVis}}" Background="#80FFFFFF">
            <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}" Value="0" IsIndeterminate="True" Width="50" Height="50" Foreground="#4F46E5"/>
        </Grid>
    </Grid>
</Page>
